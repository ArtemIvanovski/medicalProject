<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-2 col-md-3">
            <div class="nutrition-sidebar">
                <h5>Питание</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition">
                            <i class="fas fa-chart-line"></i> Обзор
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition/search">
                            <i class="fas fa-search"></i> Поиск продуктов
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition/my-products">
                            <i class="fas fa-user"></i> Мои продукты
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition/products/create">
                            <i class="fas fa-plus"></i> Создать продукт
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition/recipes">
                            <i class="fas fa-book"></i> Рецепты
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" routerLink="/patient/monitoring/nutrition/diary">
                            <i class="fas fa-calendar"></i> Дневник питания
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/patient/monitoring/nutrition/analytics">
                            <i class="fas fa-chart-bar"></i> Аналитика
                        </a>
                    </li>
                </ul>
            </div>
        </div>


        <!-- Main Content -->
        <div class="col-lg-10 col-md-9">
            <div class="nutrition-content">
                <!-- Header -->
                <div class="page-header">
                    <h2>Дневник питания</h2>
                    <p class="text-muted">Просматривайте и редактируйте свой дневник питания</p>
                </div>

                <!-- Date and Period Selection -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body selection-card-body">
                                <div class="selection-container">
                                    <div class="date-navigation">
                                        <label class="form-label">Навигация по датам:</label>
                                        <div class="date-nav-wrapper">
                                            <button type="button" class="btn btn-nav" (click)="previousDate()" title="Предыдущий период">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <div class="date-input-wrapper">
                                                <i class="fas fa-calendar-alt date-icon"></i>
                                                <input 
                                                    type="date" 
                                                    class="form-control date-input" 
                                                    [value]="formatDate(selectedDate)"
                                                    (change)="onDateChange($event)">
                                            </div>
                                            <button type="button" class="btn btn-nav" (click)="nextDate()" title="Следующий период">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="period-selection">
                                        <label class="form-label">Период:</label>
                                        <div class="period-switch">
                                            <div class="switch-container">
                                                <input type="checkbox" class="switch-input" id="period-switch" 
                                                       [checked]="selectedPeriod === 'week'" 
                                                       (change)="onPeriodSwitchChange($event)">
                                                <label for="period-switch" class="switch-label">
                                                    <span class="switch-text">{{ selectedPeriod === 'day' ? 'День' : 'Неделя' }}</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="current-period">
                                        <label class="form-label">Текущий период:</label>
                                        <div class="current-period-display">
                                            <i class="fas fa-calendar-alt period-icon"></i>
                                            <span class="period-text">
                                                {{ selectedPeriod === 'day' ? (selectedDate | date:'dd.MM.yyyy') : 
                                                   ('Неделя с ' + (selectedDate | date:'dd.MM.yyyy')) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div class="row mb-4 stats-cards-row">
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    {{ selectedPeriod === 'day' ? 'Дневная статистика' : 'Недельная статистика' }}
                                </h5>
                                <small class="text-muted">
                                    {{ selectedPeriod === 'day' ? (selectedDate | date:'dd.MM.yyyy') : 
                                       ('Неделя с ' + (selectedDate | date:'dd.MM.yyyy')) }}
                                </small>
                            </div>
                            <div class="card-body">
                                <div *ngIf="isLoading" class="text-center">
                                    <div class="spinner-border" role="status"></div>
                                </div>

                                <div *ngIf="!isLoading && dailyStats" class="nutrition-stats">
                                    <!-- Calories Circle -->
                                    <div class="row">
                                        <div class="col-md-5 text-center">
                                            <div class="calories-circle">
                                                <div class="circle-progress"
                                                     [attr.data-percentage]="getCaloriesPercentage()">
                                                    <div class="circle-inner">
                                                        <div class="calories-consumed">{{ formatNumber(dailyStats.calories || 0) }}</div>
                                                        <div class="calories-label">съедено</div>
                                                        <div class="calories-remaining" *ngIf="dailyGoal">
                                                            {{ getCaloriesRemaining() > 0 ? '-' + formatNumber(getCaloriesRemaining()) : '+' + formatNumber(abs(getCaloriesRemaining())) }}
                                                        </div>
                                                        <div class="calories-goal" *ngIf="dailyGoal">{{ formatNumber(dailyGoal.calories_goal) }} ккал цель</div>
                                                        <div class="calories-goal" *ngIf="!dailyGoal">Цель не установлена</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-7">
                                            <div class="macros-breakdown">
                                                <!-- Protein -->
                                                <div class="macro-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="macro-label">
                                                            <span class="macro-dot protein"></span>
                                                            Белки
                                                        </span>
                                                        <span class="macro-values">{{ formatNumber(dailyStats.protein || 0) }}
                                                            <span *ngIf="dailyGoal">/ {{ formatNumber(dailyGoal.protein_goal) }}г</span>
                                                            <span *ngIf="!dailyGoal">г</span>
                                                        </span>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="dailyGoal">
                                                        <div class="progress-bar protein-bar"
                                                             [style.width.%]="getProteinPercentage()"></div>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="!dailyGoal">
                                                        <div class="progress-bar protein-bar" style="width: 0%"></div>
                                                    </div>
                                                </div>

                                                <!-- Fat -->
                                                <div class="macro-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="macro-label">
                                                            <span class="macro-dot fat"></span>
                                                            Жиры
                                                        </span>
                                                        <span class="macro-values">{{ formatNumber(dailyStats.fat || 0) }}
                                                            <span *ngIf="dailyGoal">/ {{ formatNumber(dailyGoal.fat_goal) }}г</span>
                                                            <span *ngIf="!dailyGoal">г</span>
                                                        </span>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="dailyGoal">
                                                        <div class="progress-bar fat-bar"
                                                             [style.width.%]="getFatPercentage()"></div>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="!dailyGoal">
                                                        <div class="progress-bar fat-bar" style="width: 0%"></div>
                                                    </div>
                                                </div>

                                                <!-- Carbs -->
                                                <div class="macro-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="macro-label">
                                                            <span class="macro-dot carbs"></span>
                                                            Углеводы
                                                        </span>
                                                        <span class="macro-values">{{ formatNumber(dailyStats.carbohydrate || 0) }}
                                                            <span *ngIf="dailyGoal">/ {{ formatNumber(dailyGoal.carbohydrate_goal) }}г</span>
                                                            <span *ngIf="!dailyGoal">г</span>
                                                        </span>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="dailyGoal">
                                                        <div class="progress-bar carbs-bar"
                                                             [style.width.%]="getCarbohydratePercentage()"></div>
                                                    </div>
                                                    <div class="progress macro-progress" *ngIf="!dailyGoal">
                                                        <div class="progress-bar carbs-bar" style="width: 0%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div *ngIf="!isLoading && !dailyStats" class="text-center text-muted">
                                    <i class="fas fa-utensils fa-3x mb-3"></i>
                                    <p>Нет данных о питании на выбранную дату</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compact Info -->
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Краткая информация</h5>
                            </div>
                            <div class="card-body compact-info-body">
                                <div class="compact-info-grid">
                                    <div class="compact-info-item">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-calendar text-primary"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Дата</div>
                                            <div class="compact-info-value">{{ selectedDate | date:'dd.MM.yyyy' }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="compact-info-item">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-utensils text-success"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Приемов пищи</div>
                                            <div class="compact-info-value">{{ foodIntakes.length }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="compact-info-item" *ngIf="dailyStats">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-fire text-warning"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Калорий</div>
                                            <div class="compact-info-value">{{ formatNumber(dailyStats.calories) }} ккал</div>
                                        </div>
                                    </div>
                                    
                                    <div class="compact-info-item" *ngIf="dailyGoal">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-bullseye text-info"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Цель</div>
                                            <div class="compact-info-value">{{ formatNumber(dailyGoal.calories_goal) }} ккал</div>
                                        </div>
                                    </div>
                                    
                                    <div class="compact-info-item" *ngIf="getTotalPages() > 1">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-file-alt text-secondary"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Страница</div>
                                            <div class="compact-info-value">{{ currentPage }} / {{ getTotalPages() }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="compact-info-item">
                                        <div class="compact-info-icon">
                                            <i class="fas fa-clock text-muted"></i>
                                        </div>
                                        <div class="compact-info-content">
                                            <div class="compact-info-label">Обновлено</div>
                                            <div class="compact-info-value">{{ 'now' | date:'HH:mm' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Food Diary Table -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="card">
                            <div *ngIf="isLoading" class="card-body text-center py-5">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-3 text-muted">Загрузка дневника...</p>
                            </div>

                            <div *ngIf="!isLoading && foodIntakes.length === 0" class="card-body text-center text-muted py-5">
                                <i class="fas fa-utensils fa-3x mb-3"></i>
                                <h5>Нет записей в дневнике</h5>
                                <p>На выбранную дату нет записей о приемах пищи</p>
                                <a routerLink="/patient/monitoring/nutrition/search" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Добавить продукт
                                </a>
                            </div>

                            <div *ngIf="!isLoading && foodIntakes.length > 0" class="modern-table-container">
                                <!-- Table Header with Stats -->
                                <div class="table-header">
                                    <div class="table-header-content">
                                        <div class="header-info">
                                            <h5 class="table-title">
                                                <i class="fas fa-calendar-check"></i>
                                                Дневник питания
                                            </h5>
                                            <div class="header-stats">
                                                <span class="stat-item">
                                                    <i class="fas fa-utensils"></i>
                                                    {{ foodIntakes.length }} записей
                                                </span>
                                                <span class="stat-item" *ngIf="getTotalPages() > 1">
                                                    <i class="fas fa-file-alt"></i>
                                                    Стр. {{ currentPage }} из {{ getTotalPages() }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="header-actions">
                                            <a routerLink="/patient/monitoring/nutrition/search" class="btn btn-primary btn-add">
                                                <i class="fas fa-plus"></i> Добавить
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Responsive Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover modern-table">
                                        <thead class="table-header-sticky">
                                            <tr>
                                                <th width="60" class="text-center">
                                                    <i class="fas fa-image"></i>
                                                </th>
                                                <th>
                                                    <i class="fas fa-apple-alt me-2"></i>Продукт
                                                </th>
                                                <th width="120" class="text-center">
                                                    <i class="fas fa-weight me-2"></i>Количество
                                                </th>
                                                <th width="100" class="text-center">
                                                    <i class="fas fa-clock me-2"></i>Время
                                                </th>
                                                <th width="280" class="text-center">
                                                    <i class="fas fa-chart-bar me-2"></i>Пищевая ценность
                                                </th>
                                                <th width="120" class="text-center">
                                                    <i class="fas fa-cogs me-2"></i>Действия
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let intake of paginatedIntakes; let i = index" class="table-row">
                                                <td class="text-center">
                                                    <div class="product-icon-small">
                                                        <img *ngIf="getIntakeImageUrl(intake)" 
                                                             [src]="getIntakeImageUrl(intake)" 
                                                             alt="{{ intake.product_name }}"
                                                             class="product-image-small"
                                                             (error)="onImageError($event)">
                                                        <i *ngIf="!getIntakeImageUrl(intake)" 
                                                           class="fas {{ getIntakeIcon(intake) }}"></i>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="product-info">
                                                        <h6 class="product-name">{{ intake.product_name }}</h6>
                                                        <small class="product-notes" *ngIf="intake.notes">
                                                            <i class="fas fa-sticky-note"></i> {{ intake.notes }}
                                                        </small>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <div class="amount-info">
                                                        <span class="amount-value">{{ formatNumber(intake.amount) }}</span>
                                                        <small class="amount-unit">{{ getUnitDisplay(intake.unit) }}</small>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="time-badge">{{ intake.consumed_at | date:'HH:mm' }}</span>
                                                </td>
                                                <td>
                                                    <div class="nutrition-grid-modern">
                                                        <div class="nutrition-item-modern calories">
                                                            <div class="nutrition-value">{{ formatNumber(intake.calories_consumed) }}</div>
                                                            <div class="nutrition-label">ккал</div>
                                                        </div>
                                                        <div class="nutrition-item-modern protein">
                                                            <div class="nutrition-value">{{ formatNumber(intake.protein_consumed) }}</div>
                                                            <div class="nutrition-label">Б</div>
                                                        </div>
                                                        <div class="nutrition-item-modern fat">
                                                            <div class="nutrition-value">{{ formatNumber(intake.fat_consumed) }}</div>
                                                            <div class="nutrition-label">Ж</div>
                                                        </div>
                                                        <div class="nutrition-item-modern carbs">
                                                            <div class="nutrition-value">{{ formatNumber(intake.carbohydrate_consumed) }}</div>
                                                            <div class="nutrition-label">У</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="action-buttons-modern">
                                                        <button class="btn btn-action btn-edit" 
                                                                (click)="editIntake(intake)"
                                                                title="Редактировать">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-action btn-delete" 
                                                                (click)="deleteIntake(intake)"
                                                                title="Удалить">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Modern Pagination -->
                                <div *ngIf="getTotalPages() > 1" class="modern-pagination">
                                    <nav aria-label="Пагинация дневника">
                                        <ul class="pagination pagination-modern">
                                            <li class="page-item" [class.disabled]="currentPage === 1">
                                                <button class="page-link page-nav" (click)="changePage(currentPage - 1)" 
                                                        [disabled]="currentPage === 1">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                            </li>
                                            
                                            <li *ngFor="let page of getPageNumbers()" 
                                                class="page-item" 
                                                [class.active]="page === currentPage">
                                                <button class="page-link page-number" (click)="changePage(page)">
                                                    {{ page }}
                                                </button>
                                            </li>
                                            
                                            <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                                                <button class="page-link page-nav" (click)="changePage(currentPage + 1)" 
                                                        [disabled]="currentPage === getTotalPages()">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div *ngIf="error" class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Edit Modal -->
<div class="modal fade" 
     [class.show]="showEditModal" 
     [style.display]="showEditModal ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog" 
     id="editModal"
     *ngIf="showEditModal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Редактировать прием пищи
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeEditModal()"></button>
            </div>

            <form [formGroup]="editForm" (ngSubmit)="saveIntake()">
                <div class="modal-body">
                    <div *ngIf="selectedIntake" class="alert alert-info">
                        <strong>Продукт:</strong> {{ selectedIntake.product_name }}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-weight me-2"></i>
                                    Количество
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       formControlName="amount" 
                                       placeholder="Введите количество" 
                                       min="0.1" 
                                       step="0.1"
                                       required>
                                <div class="invalid-feedback" 
                                     *ngIf="editForm.get('amount')?.invalid && editForm.get('amount')?.touched">
                                    Введите корректное количество
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-ruler me-2"></i>
                                    Единица измерения
                                </label>
                                <select class="form-select" formControlName="unit">
                                    <option value="g">граммы (г)</option>
                                    <option value="ml">миллилитры (мл)</option>
                                    <option value="pieces">штуки</option>
                                    <option value="tbsp">столовые ложки</option>
                                    <option value="tsp">чайные ложки</option>
                                    <option value="cup">стаканы</option>
                                    <option value="serving">порции</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-clock me-2"></i>
                            Время приема пищи
                        </label>
                        <input type="datetime-local" 
                               class="form-control" 
                               formControlName="consumed_at"
                               required>
                        <div class="invalid-feedback" 
                             *ngIf="editForm.get('consumed_at')?.invalid && editForm.get('consumed_at')?.touched">
                            Выберите время приема пищи
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>
                            Заметки (необязательно)
                        </label>
                        <textarea class="form-control" 
                                  formControlName="notes" 
                                  rows="3" 
                                  placeholder="Добавьте заметки о приеме пищи..."></textarea>
                    </div>

                    <!-- Preview -->
                    <div class="card bg-light" *ngIf="selectedIntake">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-eye me-2"></i>
                                Предварительный просмотр
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Продукт:</strong> {{ selectedIntake.product_name }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Количество:</strong> 
                                    {{ editForm.get('amount')?.value || 0 }} {{ getUnitDisplay(editForm.get('unit')?.value || 'g') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
                        <i class="fas fa-times me-2"></i>
                        Отмена
                    </button>
                    <button type="submit" 
                            class="btn btn-primary" 
                            [disabled]="editForm.invalid">
                        <i class="fas fa-save me-2"></i>
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" 
     [class.show]="showEditModal" 
     *ngIf="showEditModal"
     (click)="closeEditModal()"></div>


