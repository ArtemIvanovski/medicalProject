<!-- Single News -->
<section class="news-single section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-12">
                <!-- Loading State -->
                <div *ngIf="isLoadingPost" class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка статьи...</p>
                </div>

                <!-- Error State -->
                <div *ngIf="postNotFound && !isLoadingPost" class="text-center py-5">
                    <h3>{{ errorMessage }}</h3>
                    <button class="btn btn-primary mt-3" (click)="goToBlogsGrid()">
                        Вернуться к списку статей
                    </button>
                </div>

                <!-- Blog Post Content -->
                <div *ngIf="blogPost && !isLoadingPost && !postNotFound" class="row">
                    <div class="col-12">
                        <div class="single-main">
                            <!-- News Head -->
                            <div class="news-head">
                                <img [src]="blogPost.featured_image_url || 'assets/img/blog1.jpg'"
                                     [alt]="blogPost.title">
                            </div>
                            <!-- News Title -->
                            <h1 class="news-title">
                                <a href="#">{{ blogPost.title }}</a>
                            </h1>
                            <!-- Meta -->
                            <div class="meta">
                                <div class="meta-left">
                                    <span class="author">
                                            <img [src]="blogPost.author_avatar_url || 'assets/img/author1.jpg'"
                                                 [alt]="blogPost.author_name">
                                        {{ blogPost.author_name }}
                                    </span>
                                    <span class="date">
                                        <i class="fa fa-clock"></i>{{ formatDate(blogPost.published_at || blogPost.created_at) }}
                                    </span>
                                </div>
                                <div class="meta-right">
                                    <span class="comments">
                                        <a href="#comments">
                                            <i class="fa fa-comments"></i>{{ blogPost.comments_count }} Комментариев
                                        </a>
                                    </span>
                                    <span class="views">
                                        <i class="fa fa-eye"></i>{{ blogPost.views_count }} Просмотров
                                    </span>
                                </div>
                            </div>
                            <!-- News Text -->
                            <div class="news-text">
                                <div *ngFor="let paragraph of getContentParagraphs(); let i = index">
                                    <div *ngIf="paragraph.trim()" [innerHTML]="paragraph"></div>

                                    <!-- Insert image gallery after second paragraph -->
                                    <div class="image-gallery" *ngIf="i === 1">
                                        <div class="row">
                                            <div class="col-lg-6 col-md-6 col-12">
                                                <div class="single-image">
                                                    <img src="assets/img/blog2.jpg" alt="#">
                                                </div>
                                            </div>
                                            <div class="col-lg-6 col-md-6 col-12">
                                                <div class="single-image">
                                                    <img src="assets/img/blog3.jpg" alt="#">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <!-- Categories and Tags -->
                            <div class="blog-bottom">
                                <!-- Social Share -->
                                <br><br>
                                <ul class="social-share">
                                    <li class="facebook">
                                        <a href="https://www.facebook.com/"><i class="icofont-facebook"></i><span>Facebook</span></a>
                                    </li>
                                    <li class="twitter">
                                        <a href="https://www.twitter.com/"><i
                                                class="icofont-twitter"></i><span>Twitter</span></a>
                                    </li>
                                    <li class="google-plus">
                                        <a href="https://www.google-plus.com/"><i class="icofont-google-plus"></i></a>
                                    </li>
                                    <li class="linkedin">
                                        <a href="https://www.linkedin.com/"><i class="icofont-linkedin"></i></a>
                                    </li>
                                    <li class="pinterest">
                                        <a href="https://www.pinterest.com/"><i class="icofont-pinterest"></i></a>
                                    </li>
                                </ul>
                                <!-- Next Prev -->
                                <ul class="prev-next">
                                    <li class="prev">
                                        <a (click)="goToPreviousPost()" style="cursor: pointer;"
                                           [class.disabled]="!prevPost"><i class="fa fa-angle-double-left"></i></a>
                                    </li>
                                    <li class="next">
                                        <a (click)="goToNextPost()" style="cursor: pointer;"
                                           [class.disabled]="!nextPost"><i class="fa fa-angle-double-right"></i></a>
                                    </li>
                                </ul>
                                <!--/ End Next Prev -->
                            </div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="col-12" id="comments">
                        <div class="blog-comments">
                            <h2>Все комментарии</h2>

                            <!-- Loading Comments -->
                            <div *ngIf="isLoadingComments" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="sr-only">Загрузка комментариев...</span>
                                </div>
                            </div>

                            <!-- Comments List -->
                            <div class="comments-body" *ngIf="!isLoadingComments">
                                <!-- No Comments -->
                                <div *ngIf="comments.length === 0" class="text-center py-4">
                                    <p>Пока нет комментариев. Будьте первым!</p>
                                </div>

                                <!-- Single Comments -->
                                <ng-container *ngFor="let comment of comments">
                                    <!-- Main Comment -->
                                    <div class="single-comments">
                                        <div class="main">
                                                                                    <div class="head">
                                            <img [src]="comment.avatar_url || 'assets/img/author1.jpg'" [alt]="comment.author_name"/>
                                        </div>
                                            <div class="body">
                                                <h4>{{ comment.author_name }}</h4>
                                                <div class="comment-meta">
                                                    <span class="meta">
                                                        <i class="fa fa-calendar"></i>{{ formatDateTime(comment.created_at).date }}
                                                    </span>
                                                    <span class="meta">
                                                        <i class="fa fa-clock"></i>{{ formatDateTime(comment.created_at).time }}
                                                    </span>
                                                </div>
                                                <p>{{ comment.content }}</p>
                                                <a (click)="showReplyToComment(comment.id)"><i class="fa fa-reply"></i>
                                                    ответить
                                                </a>
                                            </div>
                                        </div>

                                        <!-- Reply Form -->
                                        <div *ngIf="showReplyForm[comment.id]" class="reply-form mt-3">
                                            <br>
                                            <h5>Ответить на комментарий</h5>
                                            
                                            <!-- Authenticated User Info for Reply -->
                                            <div *ngIf="isUserAuthenticated && currentUser" class="user-info-card mb-3" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                                                <small>
                                                    <strong>Отвечаю как:</strong> {{ currentUser.first_name }} {{ currentUser.last_name }}
                                                </small>
                                            </div>
                                            
                                            <form (ngSubmit)="onReplySubmit(comment.id)" class="form">
                                                <div class="row">
                                                    <!-- Show name and email fields only for anonymous users -->
                                                    <ng-container *ngIf="!isUserAuthenticated">
                                                        <div class="col-lg-4 col-md-4 col-12">
                                                            <div class="form-group">
                                                                <i class="fa fa-user"></i>
                                                                <input type="text"
                                                                       [(ngModel)]="getReplyForm(comment.id).firstName"
                                                                       name="replyFirstName{{comment.id}}"
                                                                       placeholder="Имя"
                                                                       required>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4 col-md-4 col-12">
                                                            <div class="form-group">
                                                                <i class="fa fa-user"></i>
                                                                <input type="text"
                                                                       [(ngModel)]="getReplyForm(comment.id).lastName"
                                                                       name="replyLastName{{comment.id}}"
                                                                       placeholder="Фамилия"
                                                                       required>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4 col-md-4 col-12">
                                                            <div class="form-group">
                                                                <i class="fa fa-envelope"></i>
                                                                <input type="email"
                                                                       [(ngModel)]="getReplyForm(comment.id).email"
                                                                       name="replyEmail{{comment.id}}"
                                                                       placeholder="Ваш Email"
                                                                       required>
                                                            </div>
                                                        </div>
                                                    </ng-container>
                                                    
                                                    <div class="col-12">
                                                        <div class="form-group message">
                                                            <i class="fa fa-pencil"></i>
                                                            <textarea [(ngModel)]="getReplyForm(comment.id).message"
                                                                      name="replyMessage{{comment.id}}"
                                                                      rows="4"
                                                                      placeholder="Ваш ответ"
                                                                      required></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-group button">
                                                            <button type="submit" class="btn primary"
                                                                    [disabled]="submittingReply[comment.id]">
                                                                <span *ngIf="submittingReply[comment.id]">⏳</span>
                                                                <span *ngIf="!submittingReply[comment.id]"
                                                                      class="fa fa-plane"></span>
                                                                Отправить ответ
                                                            </button>
                                                            <button type="button" class="btn btn-secondary ml-2"
                                                                    (click)="hideReplyToComment(comment.id)">
                                                                Отмена
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Replies -->
                                    <ng-container *ngIf="comment.replies && comment.replies.length > 0">
                                        <ng-container *ngFor="let reply of comment.replies">
                                            <div class="single-comments left">
                                                <div class="main">
                                                                                                    <div class="head">
                                                    <img [src]="reply.avatar_url || 'assets/img/author2.jpg'" [alt]="reply.author_name"/>
                                                </div>
                                                    <div class="body">
                                                        <h4>{{ reply.author_name }}</h4>
                                                        <div class="comment-meta">
                                                            <span class="meta">
                                                                <i class="fa fa-calendar"></i>{{ formatDateTime(reply.created_at).date }}
                                                            </span>
                                                            <span class="meta">
                                                                <i class="fa fa-clock"></i>{{ formatDateTime(reply.created_at).time }}
                                                            </span>
                                                        </div>
                                                        <p>{{ reply.content }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Nested Replies (if any) -->
                                            <ng-container *ngIf="reply.replies && reply.replies.length > 0">
                                                <div class="single-comments left" style="margin-left: 50px;" *ngFor="let nestedReply of reply.replies">
                                                    <div class="main">
                                                        <div class="head">
                                                            <img [src]="nestedReply.avatar_url || 'assets/img/author3.jpg'" [alt]="nestedReply.author_name"/>
                                                        </div>
                                                        <div class="body">
                                                            <h4>{{ nestedReply.author_name }}</h4>
                                                            <div class="comment-meta">
                                                                <span class="meta">
                                                                    <i class="fa fa-calendar"></i>{{ formatDateTime(nestedReply.created_at).date }}
                                                                </span>
                                                                <span class="meta">
                                                                    <i class="fa fa-clock"></i>{{ formatDateTime(nestedReply.created_at).time }}
                                                                </span>
                                                            </div>
                                                            <p>{{ nestedReply.content }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                                <!--/ End Single Comments -->
                            </div>
                        </div>
                    </div>

                    <!-- Comment Form -->
                    <div class="col-12">
                        <div class="comments-form">
                            <h2>Оставить комментарий</h2>
                            
                            <!-- Authenticated User Info -->
                            <div *ngIf="isUserAuthenticated && currentUser" class="user-info-card mb-3" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <strong>Комментирую как:</strong> {{ currentUser.first_name }} {{ currentUser.last_name }} ({{ currentUser.email }})
                                    </div>
                                    <div class="ms-auto">
                                        <small class="text-muted">Авторизован</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact Form -->
                            <form class="form" (ngSubmit)="onCommentSubmit()">
                                <div class="row">
                                    <!-- Show name and email fields only for anonymous users -->
                                    <ng-container *ngIf="!isUserAuthenticated">
                                        <div class="col-lg-4 col-md-4 col-12">
                                            <div class="form-group">
                                                <i class="fa fa-user"></i>
                                                <input type="text"
                                                       [(ngModel)]="commentForm.firstName"
                                                       name="firstName"
                                                       placeholder="Имя"
                                                       required>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 col-md-4 col-12">
                                            <div class="form-group">
                                                <i class="fa fa-user"></i>
                                                <input type="text"
                                                       [(ngModel)]="commentForm.lastName"
                                                       name="lastName"
                                                       placeholder="Фамилия"
                                                       required>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 col-md-4 col-12">
                                            <div class="form-group">
                                                <i class="fa fa-envelope"></i>
                                                <input type="email"
                                                       [(ngModel)]="commentForm.email"
                                                       name="email"
                                                       placeholder="Ваш Email"
                                                       required>
                                            </div>
                                        </div>
                                    </ng-container>
                                    
                                    <div class="col-12">
                                        <div class="form-group message">
                                            <i class="fa fa-pencil"></i>
                                            <textarea [(ngModel)]="commentForm.message"
                                                      name="message"
                                                      rows="7"
                                                      placeholder="Напишите ваш комментарий здесь"
                                                      required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group button">
                                            <button type="submit" class="btn primary" [disabled]="isSubmittingComment">
                                                <span *ngIf="isSubmittingComment">⏳</span>
                                                <span *ngIf="!isSubmittingComment" class="fa fa-plane"></span>
                                                Отправить комментарий
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Anonymous user note -->
                                    <div *ngIf="!isUserAuthenticated" class="col-12">
                                        <div class="text-muted mt-2">
                                            <small>
                                                <i class="fa fa-info-circle"></i>
                                                Хотите оставлять комментарии без заполнения полей? 
                                                <a href="/login" class="text-primary">Войти в систему</a>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!--/ End Contact Form -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4 col-12">
                <div class="main-sidebar">
                    <!-- Single Widget -->
                    <div class="single-widget search">
                        <div class="form">
                            <input type="text" placeholder="Поиск..." (input)="onSearch($event)">
                            <a class="button" href="#"><i class="fa fa-search"></i></a>
                        </div>
                    </div>
                    <!--/ End Single Widget -->

                    <!-- Single Widget -->
                    <div class="single-widget category">
                        <h3 class="title">Категории блога</h3>

                        <!-- Loading Categories -->
                        <div *ngIf="isLoadingCategories" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">Загрузка...</span>
                            </div>
                        </div>

                        <!-- Categories List -->
                        <ul class="categor-list" *ngIf="!isLoadingCategories">
                            <li *ngFor="let category of categories">
                                <a (click)="onCategoryClick(category)" style="cursor: pointer;">
                                    {{ category.name }}
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!--/ End Single Widget -->

                    <!-- Single Widget -->
                    <div class="single-widget recent-post">
                        <h3 class="title">Недавние статьи</h3>

                        <!-- Loading Recent Posts -->
                        <div *ngIf="isLoadingRecent" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">Загрузка...</span>
                            </div>
                        </div>

                        <!-- Recent Posts List -->
                        <div *ngIf="!isLoadingRecent">
                            <!-- Single Post -->
                            <div class="single-post" *ngFor="let post of recentPosts">
                                <div class="image">
                                    <img [src]="post.featured_image_url || 'assets/img/blog-sidebar1.jpg'"
                                         [alt]="post.title">
                                </div>
                                <div class="content">
                                    <h5>
                                        <a (click)="onRecentPostClick(post)" style="cursor: pointer;">
                                            {{ post.title }}
                                        </a>
                                    </h5>
                                    <ul class="comment">
                                        <li>
                                            <i class="icofont-calendar"
                                               aria-hidden="true"></i>{{ formatDate(post.published_at || post.created_at) }}
                                        </li>
                                        <li>
                                            <i class="icofont-speech-comments"
                                               aria-hidden="true"></i>{{ post.comments_count }}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <!-- End Single Post -->
                        </div>
                    </div>
                    <!--/ End Single Widget -->

                    <!-- Single Widget -->
                    <div class="single-widget side-tags">
                        <h3 class="title">Теги</h3>

                        <!-- Loading Tags -->
                        <div *ngIf="isLoadingTags" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">Загрузка...</span>
                            </div>
                        </div>

                        <!-- Tags List -->
                        <ul class="tag" *ngIf="!isLoadingTags">
                            <li *ngFor="let tag of tags">
                                <a (click)="onTagClick(tag)" style="cursor: pointer;">
                                    {{ tag.name }}
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!--/ End Single Widget -->
                </div>
            </div>
        </div>
    </div>
</section>
<!--/ End Single News -->
